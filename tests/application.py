from collections import defaultdict
import unittest
from unittest.mock import patch
from rma.application import RmaApplication


class ApplicationTestCase(unittest.TestCase):
    def setUp(self):
        patch('rma.application.connect_to_redis', return_value=None).start()
        self.app = RmaApplication(filters={})

    def tearDown(self):
        pass

    def test_get_pattern_aggregated_data(self):
        aggregate_patterns = self.app.get_pattern_aggregated_data([
            {'name': 'jimmy18ngo@gmail.com-*'},
            {'name': 'belgical@msn.com-*'},
            {'name': '447486656-shipment-info'},
            {'name': 'elisabeth.amitsis@icloud.com-*-intelligence-orders'},
            {'name': '60d380a28858772edcf4115b-*-cck-email'},
            {'name': '75240560-shipment-info'},
            {'name': 'marie.menina17@gmail.com-*-*'},
            {'name': '367568-*-productproperties'},
            {'name': 'shasdaycare@aol.com-369076-productpreference'},
            {'name': '265-5638400090XS-availability'},
            {'name': '61524d317c830a89a051f25d-346021-7-cck-email'},
        ])
        self.assertEqual(19, len(aggregate_patterns))
        self.assertCountEqual(aggregate_patterns.keys(), [
            'EMAIL-*',
            'shipment-info',
            'ID-shipment-info',
            'intelligence-orders',
            'EMAIL-*-intelligence-orders', 
            'cck-email', 
            'ID-*-cck-email', 
            'EMAIL-*-*', 
            'FRANCHISE-367568', 
            'productproperties', 
            'FRANCHISEID-*-productproperties', 
            'FRANCHISE-369076', 
            'productpreference', 
            'EMAIL-FRANCHISEID-productpreference', 
            'FRANCHISE-265', 
            'availability',
            'FRANCHISEID-ID-availability',
            'ID-FRANCHISEID-CHANNEL-cck-email',
            'FRANCHISE-346021'])

    def test_do_ram(self):
        keys = {0: {'gr8mom1964@aol.com': ['gr8mom1964@aol.com-369206-productpreference'], 'productpreference': ['gr8mom1964@aol.com-369206-productpreference', 'rum42187@gmail.com-399-productpreference', 'rishitharishu96@gmail.com-399-productpreference', 'elaine27lopez@hotmail.com-346021-productpreference', 'staker01@gmail.com-346021-productpreference', 'radocays@gmail.com-346021-productpreference', 'shasdaycare@aol.com-369076-productpreference', 'emmyweissman@gmail.com-399-productpreference', 'queenswoop@gmail.com-369076-productpreference', 'mcwhlr@gmail.com-83396-productpreference'], 'EMAIL-369206-productpreference': ['gr8mom1964@aol.com-369206-productpreference'], 'shipment-info': ['406308840-shipment-info', '52314702-shipment-info', '580239578-shipment-info', '557200866-shipment-info', '296798500-shipment-info', '700099678-shipment-info', '211949418-shipment-info', '211139408-shipment-info', '673321132-shipment-info', '205665440-shipment-info', '256118828-shipment-info', '402836486-shipment-info', '106981670-shipment-info', '669922620-shipment-info', '174645860-shipment-info', '541801170-shipment-info', '417151514-shipment-info', '766202636-shipment-info', '388258772-shipment-info', '496956106-shipment-info', '704005832-shipment-info', '473048858-shipment-info', '394505250-shipment-info', '351260236-shipment-info', '25343188-shipment-info', '516785192-shipment-info', '288293246-shipment-info', '666110022-shipment-info', '367958190-shipment-info', '337628746-shipment-info', '311768092-shipment-info', '361602836-shipment-info', '326975318-shipment-info', '265190174-shipment-info', '705279732-shipment-info', '679677724-shipment-info', '448304654-shipment-info', '423448648-shipment-info', '425742344-shipment-info', '346799130-shipment-info', '627176992-shipment-info', '560244844-shipment-info', '129944140-shipment-info', '704095772-shipment-info', '239518526-shipment-info', '8664942-shipment-info', '211477806-shipment-info', '533086842-shipment-info', '313383548-shipment-info', '409499254-shipment-info', '318903002-shipment-info', '255003580-shipment-info', '449802938-shipment-info', '607544676-shipment-info', '147758076-shipment-info'], 'ID-shipment-info': ['406308840-shipment-info', '52314702-shipment-info', '580239578-shipment-info', '557200866-shipment-info', '296798500-shipment-info', '700099678-shipment-info', '211949418-shipment-info', '211139408-shipment-info', '673321132-shipment-info', '205665440-shipment-info', '256118828-shipment-info', '402836486-shipment-info', '106981670-shipment-info', '669922620-shipment-info', '174645860-shipment-info', '541801170-shipment-info', '417151514-shipment-info', '766202636-shipment-info', '388258772-shipment-info', '496956106-shipment-info', '704005832-shipment-info', '473048858-shipment-info', '394505250-shipment-info', '351260236-shipment-info', '25343188-shipment-info', '516785192-shipment-info', '288293246-shipment-info', '666110022-shipment-info', '367958190-shipment-info', '337628746-shipment-info', '311768092-shipment-info', '361602836-shipment-info', '326975318-shipment-info', '265190174-shipment-info', '705279732-shipment-info', '679677724-shipment-info', '448304654-shipment-info', '423448648-shipment-info', '425742344-shipment-info', '346799130-shipment-info', '627176992-shipment-info', '560244844-shipment-info', '129944140-shipment-info', '704095772-shipment-info', '239518526-shipment-info', '8664942-shipment-info', '211477806-shipment-info', '533086842-shipment-info', '313383548-shipment-info', '409499254-shipment-info', '318903002-shipment-info', '255003580-shipment-info', '449802938-shipment-info', '607544676-shipment-info', '147758076-shipment-info'], 'allisonl46@aol.com': ['allisonl46@aol.com-83396-order_id-51010379'], 'EMAIL-83396-order_id-51010379': ['allisonl46@aol.com-83396-order_id-51010379'], 'address': ['285524508-address', '388710306-address'], 'ID-address': ['285524508-address', '388710306-address'], 'deannieaskew@gmail.com': ['deannieaskew@gmail.com-369250-all-orders'], 'all-orders': ['deannieaskew@gmail.com-369250-all-orders', 'jess1308@hotmail.com-2613-all-orders'], 'EMAIL-369250-all-orders': ['deannieaskew@gmail.com-369250-all-orders'], 'christina@obrienphoto.com': ['christina@obrienphoto.com-346021-servicepreference'], 'servicepreference': ['christina@obrienphoto.com-346021-servicepreference', 'yurapina@hotmail.com-346021-servicepreference', 'trujillowv@icloud.com-346021-servicepreference', 'cselder@aol.com-369076-servicepreference'], 'EMAIL-346021-servicepreference': ['christina@obrienphoto.com-346021-servicepreference', 'yurapina@hotmail.com-346021-servicepreference', 'trujillowv@icloud.com-346021-servicepreference'], 'jeanniewilliford@yahoo.com': ['jeanniewilliford@yahoo.com-366336-shopperorder'], 'shopperorder': ['jeanniewilliford@yahoo.com-366336-shopperorder', 'anayaredy68@hotmail.com-369048-shopperorder', 'lisa2am@msn.com-369048-shopperorder'], 'EMAIL-366336-shopperorder': ['jeanniewilliford@yahoo.com-366336-shopperorder'], 'rum42187@gmail.com': ['rum42187@gmail.com-399-productpreference'], 'EMAIL-399-productpreference': ['rum42187@gmail.com-399-productpreference', 'rishitharishu96@gmail.com-399-productpreference', 'emmyweissman@gmail.com-399-productpreference'], 'michaelaortizjr@gmail.com': ['michaelaortizjr@gmail.com-399-ctx-intelligence-orders'], 'ctx-intelligence-orders': ['michaelaortizjr@gmail.com-399-ctx-intelligence-orders', 'duschepker@gmail.com-369076-ctx-intelligence-orders', 'lilisalazar_16@hotmail.com-346021-ctx-intelligence-orders', 'annapetrosyan92@mail.ru-346021-ctx-intelligence-orders', 'ilike772001@gmail.com-369206-ctx-intelligence-orders', 'ossodonna@yahoo.com-346021-ctx-intelligence-orders'],
                    'EMAIL-399-ctx-intelligence-orders': ['michaelaortizjr@gmail.com-399-ctx-intelligence-orders'], 'anayaredy68@hotmail.com': ['anayaredy68@hotmail.com-369048-shopperorder'], 'EMAIL-369048-shopperorder': ['anayaredy68@hotmail.com-369048-shopperorder', 'lisa2am@msn.com-369048-shopperorder'], 'lisa2am@msn.com': ['lisa2am@msn.com-369048-shopperorder'], 'shekinahlewis22@yahoo.com': ['shekinahlewis22@yahoo.com-369274-serviceusage'], 'serviceusage': ['shekinahlewis22@yahoo.com-369274-serviceusage', 'am80ani@gmail.com-369048-serviceusage', 'narinemirzoyan111@gmail.com-346021-serviceusage', 'dayi_b@hotmail.com-346021-serviceusage'], 'EMAIL-369274-serviceusage': ['shekinahlewis22@yahoo.com-369274-serviceusage'], 'cck-email': ['61524d317c830a89a051f25d-346021-7-cck-email', '63aed99db31dfa8291dffa5c-369076-7-cck-email', '5ec13b60b9e241e5d826f528-346021-7-cck-email'], 'ID-346021-7-cck-email': ['61524d317c830a89a051f25d-346021-7-cck-email', '5ec13b60b9e241e5d826f528-346021-7-cck-email'], 'am80ani@gmail.com': ['am80ani@gmail.com-369048-serviceusage'], 'EMAIL-369048-serviceusage': ['am80ani@gmail.com-369048-serviceusage'], 'rishitharishu96@gmail.com': ['rishitharishu96@gmail.com-399-productpreference'], 'elaine27lopez@hotmail.com': ['elaine27lopez@hotmail.com-346021-productpreference'], 'EMAIL-346021-productpreference': ['elaine27lopez@hotmail.com-346021-productpreference', 'staker01@gmail.com-346021-productpreference', 'radocays@gmail.com-346021-productpreference'], 'narinemirzoyan111@gmail.com': ['narinemirzoyan111@gmail.com-346021-serviceusage'], 'EMAIL-346021-serviceusage': ['narinemirzoyan111@gmail.com-346021-serviceusage', 'dayi_b@hotmail.com-346021-serviceusage'], 'staker01@gmail.com': ['staker01@gmail.com-346021-productpreference'], 'duschepker@gmail.com': ['duschepker@gmail.com-369076-ctx-intelligence-orders'], 'EMAIL-369076-ctx-intelligence-orders': ['duschepker@gmail.com-369076-ctx-intelligence-orders'], 'shusfeldt01@gmail.com': ['shusfeldt01@gmail.com-399-order_product_id-2653070194'], 'EMAIL-399-order_product_id-2653070194': ['shusfeldt01@gmail.com-399-order_product_id-2653070194'], 'lilisalazar_16@hotmail.com': ['lilisalazar_16@hotmail.com-346021-ctx-intelligence-orders'], 'EMAIL-346021-ctx-intelligence-orders': ['lilisalazar_16@hotmail.com-346021-ctx-intelligence-orders', 'annapetrosyan92@mail.ru-346021-ctx-intelligence-orders', 'ossodonna@yahoo.com-346021-ctx-intelligence-orders'], 'reisjenny14@gmail.com': ['reisjenny14@gmail.com-346021-order_product_id-2670935130'], 'EMAIL-346021-order_product_id-2670935130': ['reisjenny14@gmail.com-346021-order_product_id-2670935130'], 'isabeljaramillo70@yahoo.com': ['isabeljaramillo70@yahoo.com-context'], 'context': ['isabeljaramillo70@yahoo.com-context'], 'EMAIL-context': ['isabeljaramillo70@yahoo.com-context'], 'yurapina@hotmail.com': ['yurapina@hotmail.com-346021-servicepreference'], 'christy.perez@ymail.com': ['christy.perez@ymail.com-83396-order_id-65132529'], 'EMAIL-83396-order_id-65132529': ['christy.perez@ymail.com-83396-order_id-65132529'], 'annapetrosyan92@mail.ru': ['annapetrosyan92@mail.ru-346021-ctx-intelligence-orders'], 'laurielalama@aol.com': ['laurielalama@aol.com-346021-order_product_id-2664436108'], 'EMAIL-346021-order_product_id-2664436108': ['laurielalama@aol.com-346021-order_product_id-2664436108'], 'niejingjing01@gmail.com': ['niejingjing01@gmail.com-369048-order_product_id-2535654332'], 'EMAIL-369048-order_product_id-2535654332': ['niejingjing01@gmail.com-369048-order_product_id-2535654332'], 'ID-369076-7-cck-email': ['63aed99db31dfa8291dffa5c-369076-7-cck-email'], 'radocays@gmail.com': ['radocays@gmail.com-346021-productpreference'], 'shasdaycare@aol.com': ['shasdaycare@aol.com-369076-productpreference'], 'EMAIL-369076-productpreference': ['shasdaycare@aol.com-369076-productpreference', 'queenswoop@gmail.com-369076-productpreference'], 'emmyweissman@gmail.com': ['emmyweissman@gmail.com-399-productpreference'], 'queenswoop@gmail.com': ['queenswoop@gmail.com-369076-productpreference'], 'tngrandma7@outlook.com': ['tngrandma7@outlook.com-369206-order_product_id-2636586916'], 'EMAIL-369206-order_product_id-2636586916': ['tngrandma7@outlook.com-369206-order_product_id-2636586916'], 'jess1308@hotmail.com': ['jess1308@hotmail.com-2613-all-orders'], 'EMAIL-2613-all-orders': ['jess1308@hotmail.com-2613-all-orders'], 'breannacaras@gmail.com': ['breannacaras@gmail.com-369206-order_product_id-2447917364'], 'EMAIL-369206-order_product_id-2447917364': ['breannacaras@gmail.com-369206-order_product_id-2447917364'], 'mcwhlr@gmail.com': ['mcwhlr@gmail.com-83396-productpreference'], 'EMAIL-83396-productpreference': ['mcwhlr@gmail.com-83396-productpreference'], 'leesbmom@gmail.com': ['leesbmom@gmail.com-369076-order_id-59851553'], 'EMAIL-369076-order_id-59851553': ['leesbmom@gmail.com-369076-order_id-59851553'], 'ilike772001@gmail.com': ['ilike772001@gmail.com-369206-ctx-intelligence-orders'], 'EMAIL-369206-ctx-intelligence-orders': ['ilike772001@gmail.com-369206-ctx-intelligence-orders'], 'dayi_b@hotmail.com': ['dayi_b@hotmail.com-346021-serviceusage'], 'trujillowv@icloud.com': ['trujillowv@icloud.com-346021-servicepreference'], 'ossodonna@yahoo.com': ['ossodonna@yahoo.com-346021-ctx-intelligence-orders'], 'cselder@aol.com': ['cselder@aol.com-369076-servicepreference'], 'EMAIL-369076-servicepreference': ['cselder@aol.com-369076-servicepreference'], 'availability': ['369042-00501022603536-availability'], 'ID-00501022603536-availability': ['369042-00501022603536-availability'], 'katie.burzynski@outlook.com': ['katie.burzynski@outlook.com-369274-order_id-cacar08999453'], 'EMAIL-369274-order_id-cacar08999453': ['katie.burzynski@outlook.com-369274-order_id-cacar08999453']}}
        results = self.app.do_ram(keys)
        self.assertDictEqual(results, {'stat': {}})
